{{- $inServerMode := .Site.IsServer -}}
{{- $sassIncludes := (slice "dist/scss/") -}}
{{- $scss         := resources.Get "scss/module/hugo-uswds/styles.scss" -}}
{{- $vars := dict "siteBaseURL" $.Site.BaseURL -}}
{{- $cssTarget    := "css/hugo-uswds.css" -}}
{{- $cssOpts      := dict "transpiler" "dartsass" "targetPath" $cssTarget "outputStyle" "compressed" "vars" $vars -}}
{{- $cssOpts      := merge $cssOpts (dict "includePaths" $sassIncludes) -}}
{{- if $inServerMode -}}
  {{- $cssOpts := merge $cssOpts (dict "enableSourceMap" true "sourceMapIncludeSources" true) -}}
{{- end -}}
{{- $postCSSOpts      := dict "use" "autoprefixer" -}}

{{- if $inServerMode -}}
  {{- $css := $scss | toCSS $cssOpts | postCSS $postCSSOpts }}
  {{- if hugo.IsProduction -}}
    {{- $css = $css | resources.PostProcess -}}
  {{- end -}}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}">
{{- else -}}
  {{- $css := $scss | toCSS $cssOpts | postCSS $postCSSOpts -}}
  {{- $css = $css | resources.Fingerprint "sha512" }}
  {{- if hugo.IsProduction -}}
    {{- $css = $css | resources.PostProcess -}}
  {{- end -}}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}" crossorigin="anonymous">
{{- end -}}

